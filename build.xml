<project name="Qarma">


  <!-- Note: it is important that this file, build.xml, remain
       at the top of the directory, as it refers to directories
       in relationship to its location -->

  <!-- ################ -->
  <!--    PROPERTIES    -->
  <!-- ################ -->
  <!-- assign values to be used elsewhere in this script -->
  <!--====================================================-->

  <property name="tomcat.home.bin" 
    value="web_container/apache-tomcat-8.0.14/bin/" />
  <property name="tomcat.webapps.dir" 
    value="web_container/apache-tomcat-8.0.14/webapps/" />
  <property name="tomcat.lib.dir" 
    value="web_container/apache-tomcat-8.0.14/lib/" />

 


  <!-- ##################### -->
  <!--    COMBINED TARGETS   -->
  <!-- ##################### -->
  <!-- Targets that combine other targets for ease of use -->
  <!--====================================================-->

  <!-- cleans, builds, installs into container, restarts tomcat -->
  <target name="run" 
    description="cleans, builds, installs, restarts">
    <antcall target="full-clean" />
    <antcall target="compile" />
    <antcall target="install" />
    <antcall target="tomcat-restart" />
  </target>


  <!-- ################ -->
  <!--    CLEANING      -->
  <!-- ################ -->
  <!-- targets that deleted generated files and directories -->
  <!--======================================================-->

  <!-- deletes all directories that will be generated by this script. --> 
  <!-- that is, the build and webapp directories -->
  <target 
    name="full-clean" 
    description="deletes the build directory">
    <antcall target="clean-webapp-dir" />
    <antcall target="clean-build-dir" />
  </target>


  <!-- deletes the webapp directory --> 
  <target 
    name="clean-webapp-dir" 
    description="deletes the webapp directory">
    <delete dir="${tomcat.webapps.dir}qarma" />
  </target>


  <!-- deletes the build directory --> 
  <target 
    name="clean-build-dir" 
    description="deletes the build directory">
    <delete dir="build"/>
  </target>



  <!-- ################ -->
  <!--   COMPILATION    -->
  <!-- ################ -->
  <!-- compiling the java files into classes into the build directory -->
  <!--================================================================-->

  <!-- builds the Java classes necessary for the functioning of the
  system.  All classes are built and put in the build directory, and
  other Ant targets move these files to their intended destination -->
  <target name="compile" description="compiles all java files">
    <mkdir dir="build/classes"/>
             <!-- lots of debugging -->
    <javac 
      debug="true" 
      debuglevel="lines,vars,source" 
      includeantruntime="false" 
      classpath="
        lib/mysql-connector-java-5.1.33-bin.jar:
        ${tomcat.lib.dir}servlet-api.jar"
      srcdir="src" 
      destdir="build/classes">
      <compilerarg value="-Xlint:unchecked" /> <!-- for more warnings -->
    </javac>
  </target>


  <!-- copies the jsp and html files into the webapp directory.  -->
  <target name="copy-webapp-into-container"
    description="move files into web container">
    <copy todir="${tomcat.webapps.dir}qarma" >
      <!-- Note: **/* will include all sub-directories. -->
      <fileset dir="src/webapp" includes="**/*" />
    </copy>
    <mkdir dir="${tomcat.webapps.dir}qarma/WEB-INF/classes" />
  </target>


  <!-- 
    copies the compiled classes and other resources into
    their proper locations in the web_container directory.
  -->
  <target name="install"
    depends="copy-webapp-into-container"
    description="move files into web container">
    <copy todir="${tomcat.webapps.dir}qarma/WEB-INF/classes" >
      <!-- Note: **/* will include all sub-directories. -->
      <fileset dir="build/classes" includes="**/*" />
    </copy>
  </target>



  <!-- ################ -->
  <!--   BUILD SCHEMA   -->
  <!-- ################ -->
  <!-- This is a program that runs scripts stored in the db_scripts
      directory to put the database into the right form for use with
      this app -->
  <!--====================================================-->

  <!-- 
    build-schema runs the SQL scripts necessary for the 
    database to have the proper schema.
  -->
  <target name="build-schema" 
    depends="compile" 
    description="builds the db schema.  see comments in build.xml">
    <java 
      classpath="build/classes:lib/mysql-connector-java-5.1.33-bin.jar"
      classname="com.renomad.qarma.Build_db_schema" 
      fork="true"
      />
  </target>



  <!-- ############## -->
  <!--     TOMCAT     -->
  <!-- ############## -->
  <!-- Scripts for starting, stopping, restarting Tomcat -->
  <!--====================================================-->

  <target name="tomcat-restart" description="restart the tomcat server">
      <antcall target="tomcat-stop" />
      <antcall target="tomcat-start" />
  </target>

  <target name="tomcat-start" description="start tomcat">
    <exec executable="${tomcat.home.bin}startup.sh" />
  </target>

  <target name="tomcat-stop" description="stop tomcat">
    <exec executable="${tomcat.home.bin}shutdown.sh" />
  </target>

</project>
