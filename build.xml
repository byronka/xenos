<project name="Qarma">


  <!-- Note: it is important that this file, build.xml, remain
       at the top of the directory, as it refers to directories
       in relationship to its location -->

  <!-- ################ -->
  <!--    PROPERTIES    -->
  <!-- ################ -->
  <!-- assign values to be used elsewhere in this script -->
  <!--====================================================-->

  <property name="tomcat.home.bin" 
    value="web_container/apache-tomcat-8.0.14/bin/" />
  <property name="tomcat.webapps.dir" 
    value="web_container/apache-tomcat-8.0.14/webapps/" />
  <property name="tomcat.lib.dir" 
    value="web_container/apache-tomcat-8.0.14/lib/" />

 


  <!-- ##################### -->
  <!--    COMBINED TARGETS   -->
  <!-- ##################### -->
  <!-- Targets that combine other targets for ease of use -->
  <!--====================================================-->

  <!-- This target is expected to be run when a new dev first
      gets started.  It sets up a new database, adds some sample
      data to it, then cleans and builds the classes, puts everything
      in its place, and kicks off the server.
  -->
  <target name="initial-setup-and-run" 
    description="sets up a new database with data, compiles, starts server">
    <antcall target="build-schema" />
    <antcall target="add-sample-data" />
    <antcall target="run" />
  </target>


  <!-- cleans, builds, installs into container, restarts tomcat -->
  <target name="run" 
    description="cleans, builds, installs, restarts">
    <antcall target="full-clean" />
    <antcall target="compile" />
    <antcall target="install" />
    <antcall target="tomcat-restart" />
    <echo message="Qarma is ready at http://localhost:8080/qarma"/>
  </target>


  <!-- ################ -->
  <!--    CLEANING      -->
  <!-- ################ -->
  <!-- targets that deleted generated files and directories -->
  <!--======================================================-->

  <!-- deletes all directories that will be generated by this script. --> 
  <!-- that is, the build and webapp directories -->
  <target 
    name="full-clean" 
    description="deletes the build directory">
    <antcall target="clean-build-dir" />
  </target>


  <!-- deletes the build directory --> 
  <target 
    name="clean-build-dir" 
    description="deletes the build directory">
    <delete dir="build"/>
  </target>


  <!-- deletes the database schema, and all its data -->
  <target name="delete-schema" 
    depends="compile"
    description="deletes the db schema, and ALL DATA!">
    <java 
      classpath="build/classes:lib/mysql-connector-java-5.1.33-bin.jar"
      classname="com.renomad.qarma.Delete_db_schema" 
      fork="true"
      />
  </target>


  <!-- ################ -->
  <!--   COMPILATION    -->
  <!-- ################ -->
  <!-- compiling the java files into classes into the build directory -->
  <!--================================================================-->

  <!-- builds the Java classes necessary for the functioning of the
  system.  All classes are built and put in the build directory, and
  other Ant targets move these files to their intended destination -->
  <target name="compile" description="compiles all java files">
    <mkdir dir="build/classes"/>
    <javac 
      debug="true" 
      debuglevel="lines,vars,source" 
      includeantruntime="false" 
      classpath="
        lib/mysql-connector-java-5.1.33-bin.jar:
        ${tomcat.lib.dir}servlet-api.jar"
      srcdir="src" 
      destdir="build/classes">
      <compilerarg value="-Xlint:unchecked" /> <!-- for more warnings -->
    </javac>
  </target>


  <!-- 
    copies the compiled classes and other resources into
    their proper locations in the web_container directory.
  -->
  <target name="install"
    description="move files into web container">
    <copy todir="${tomcat.webapps.dir}qarma/WEB-INF/classes" >
      <!-- Note: **/* will include all sub-directories. -->
      <fileset dir="build/classes" includes="**/*" />
    </copy>
  </target>



  <!-- ################ -->
  <!--      SCHEMA      -->
  <!-- ################ -->
  <!-- This is a program that runs scripts stored in the db_scripts
      directory to put the database into the right form for use with
      this app -->
  <!--====================================================-->

  <!-- 
    build-schema runs the SQL scripts necessary for the 
    database to have the proper schema.
  -->
  <target name="build-schema" 
    depends="compile" 
    description="builds the db schema.  see comments in build.xml">
    <java 
      classpath="build/classes:lib/mysql-connector-java-5.1.33-bin.jar"
      classname="com.renomad.qarma.Build_db_schema" 
      fork="true"
      />
  </target>


  <!-- 
    add-sample-data adds some sample data to the database to make
    testing easier.
  -->
  <target name="add-sample-data" 
    depends="compile, delete-schema, build-schema" 
    description="adds sample data to the database for testing">
    <java 
      classpath="build/classes:lib/mysql-connector-java-5.1.33-bin.jar"
      classname="com.renomad.qarma.Add_sample_data_to_db"
      fork="true"
      />
  </target>


  <!-- ############## -->
  <!--     TOMCAT     -->
  <!-- ############## -->
  <!-- Scripts for starting, stopping, restarting Tomcat -->
  <!--====================================================-->


  <!-- This target acts as a dependency to tell if Tomcat is running 
      "pidfile" is set in $CATALINA_HOME/bin/setenv.sh, and contains
      the process id of Catalina.-->
  <target name="check-if-tomcat-running">
    <available 
      file="web_container/apache-tomcat-8.0.14/temp/pidfile" 
      property="tomcat.running"/>
  </target>

  <target name="tomcat-restart" description="restart the tomcat server">
      <antcall target="tomcat-stop" />
      <antcall target="tomcat-start" />
  </target>

  <target name="tomcat-start" description="start tomcat">
    <exec executable="${tomcat.home.bin}startup.sh" />
  </target>

  <target name="tomcat-stop" 
    description="stop tomcat"
    depends="check-if-tomcat-running" 
    if="tomcat.running">
    <exec executable="${tomcat.home.bin}shutdown.sh" />
  </target>

</project>
